<!doctype html>
<html>

<head>
	<title>Dashboard</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
	<script src="http://www.chartjs.org/samples/latest/utils.js"></script>
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/dark-mode-style.css">
	<link rel="stylesheet" href="css/index.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
	<nav id="menu" onmouseover="abrir()">
		<div class="contour-icon" id="logo">
			<img src="img/logos/icon.png" alt="" id="closed">
			<img src="img/logos/logo-dark.png" id="open">
		</div>
		<div class="contour-icon" id="contour-icon">
			<i class="material-icons" style="font-size: 20px;">dashboard</i>
			<a class="funcao" id="index">Dashboard</a>
		</div>

		<div class="contour-icon" id="contour-icon">
			<i class="material-icons" style="font-size: 20px;">home</i>
			<a class="funcao" id="sala">Salas</a>
		</div>

		<div class="contour-icon" id="contour-icon">
			<i class="material-icons" style="font-size: 20px;">equalizer</i>
			<a class="funcao" id="relatorios">Relatórios</a>
		</div>
		<div class="baixo">
			<hr>
			<div class="contour-icon" id="contour-icon">
				<i class="material-icons" style="font-size: 20px;">build</i>
				<a href="#" class="funcao">Configurações</a>
			</div>
			<div class="contour-icon">
				<i class="material-icons" style="font-size: 20px;">brightness_medium</i>
				<a href="#" class="funcao">Modo escuro</a>
				<label class="switch" id='labelSwitch'>
					<input type="checkbox" id='checkDarkMode' onclick="enableDarkMode()">
					<span class="slider round"></span>
				</label>
			</div>
		</div>
	</nav>

	<section id="principal" onmouseover="fechar()">
		<div class="dashboard">
			<div class="nav-principal" id="nav-princial">
				<div class="title-dash">
					<h1>Visão Geral - <span id='nomeAcervo'></span></h1>
				</div>
				<div class="conta" id="conta">
					<img src="img/avatar.png">
					<span id="nomeUsuario">Admin</span>
					<a href="#"><i class="material-icons">arrow_drop_down</i></a>
				</div>
			</div>

			<!-- <div class="graph-top">

				<div class="box-graph-top" id="card1" onclick='expandCard("card1")'>
					<div class="area-left area-left-disabled">
						<div class="top-graph info-disabled">
							<div class="top-graph-left-top">
								<div class="info-ambiente">
									<label>Ambiente 1</label>
									<h2>Temperatura: <span id="random1">16,5</span> °C</h2>
									<h2>Nivel: <span style="color:#0078d7;" id="nivel">Médio</span></h2>
								</div>
								<div class="circle" id="circle">
									<i class="material-icons" id="icone">add_alert</i>
								</div>
							</div>
						</div>
						<div class="bottom-graph">
							<div class="card-graph" id="card-graph-bottom">
								<div id="msg"></div>
							</div>
						</div>
					</div>

					<div class="area-right">
						<div class="card-graph">
							<canvas id="chart"></canvas>
						</div>
					</div>
				</div>
			</div> -->

			<div id='area-cards'>		
				
			</div>
		</div>
	</section>

	<div id="modal-area" class="disabled">
		<div id="modal-form-area">
			<div id="close" onclick="modalAmbiente()">
				<span class="material-icons">
					close
				</span>
			</div>
			<h2>Cadastro de Ambiente</h2>
			<p>Preencha os campos abaixo para adicionar uma nova área</p>
			<form action="http://localhost:3333/area" method="POST" id='form-area'>
				<input type="text" placeholder="Tipo da área" id="tipo-area">
				<input type="text" placeholder="Nome" id='nome-area'>
				<button>Cadastrar</button>
			</form>
		</div>
	</div>

	<script type="text/javascript" src="js/js.js"></script>
	<script type="text/javascript" src="js/card-animation.js"></script>
	<script type="text/javascript" src="js/card.js"></script>

	<script src="./services/sessao.js"></script>
	<script src="./services/area.js"></script>
	<script src="./services/sensor.js"></script>
</body>

</html>

<script>
	let context = document.getElementById("chart").getContext("2d");

	let config = {
		type: 'line',
		data: {
			labels: [],
			datasets: [{
				label: 'Temperatura',
				data: [],
				backgroundColor: [
					'rgba(255, 99, 132, 1)'
				],
				borderColor: [
					'rgba(255, 99, 132, 1)'
				],
				borderWidth: 1
			},
			{
				label: 'Umidade',
				data: [],
				backgroundColor: [
					'rgba(0,0,255,0.3)'
				],
				borderColor: [
					'rgba(0,0,255,0.3)'
				],
				borderWidth: 1
			}]
		},
		options: {
			yAxes: [{
				ticks: {
					beginAtZero: true
				}
			}]
		}
	}



	let chart = new Chart(context, config);

	function getData() {
		let ajax = new XMLHttpRequest();

		ajax.open('GET', 'http://localhost:3333/sensor');
		ajax.onreadystatechange = function () {
			if (ajax.readyState == XMLHttpRequest.DONE) {
				let arr = JSON.parse(ajax.responseText);

				msg.innerHTML = `
					<p>Média Umidade: ${arr.average.Hum}</p>
					<p>Média Temperatura: ${arr.average.Temp}</p>
				`;

				fillChart(arr.data.Hum, arr.data.Temp.toFixed(2), arr.lastMoment);
			}
		}
		ajax.send();
	}

	function fillChart(umidade, temperatura, data) {

		let date = new Date(data);
		let moment = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;

		chart.data.labels.push(moment);

		if (chart.data.labels.length > 7) {
			chart.data.labels.shift();
			chart.data.datasets[0].data.shift();
			chart.data.datasets[1].data.shift();
		}

		chart.data.datasets[0].data.push(parseFloat(temperatura));
		chart.data.datasets[1].data.push(umidade);
		chart.update();
	}


	function sendData() {
		let http = new XMLHttpRequest();
		http.open('POST', 'http://localhost:3333/sensor');
		http.onreadystatechange = function () {
			if (http.status == 200 && http.readyState == 4) {
				getData();
			}
		}
		http.send();
	}

	setInterval(() => {
		sendData();
	}, 5000)
</script>